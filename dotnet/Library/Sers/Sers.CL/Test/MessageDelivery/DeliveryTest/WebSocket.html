<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>WebSocket测试</title>
    <style>

        .div1 {
            height: 88px;
            width: 173px;
            border: 1px solid blue;
            margin: auto;
        }

        h4 {
            margin: auto;
        }
    </style>
    <script>

        var webSocket = new WebSocket("ws://127.0.0.1:4503");

        webSocket.binaryType = "arraybuffer";

        webSocket.onopen = function () {
            console.log('已经打开连接');
        };

       
        webSocket.onclose = function () {
            console.log('和服务器断开连接');
        };

        webSocket.onmessage = function (event) {             
            //debugger;
            doReceive(event.data);
            //console.log('收到服务端数据：' + event.data);
        };


        ///////////


        var receive = [];
        var length = 0;
        function doReceive(buffer) {
            receive = receive.concat(Array.from(new Uint8Array(buffer)));
            if (receive.length < 4) {
                return;
            }
            length = new DataView(new Uint8Array(receive).buffer).getInt32(0, true);
            if (receive.length < length + 4) {
                return;
            }
            var bytes = receive.slice(4, length + 4);
            doSomething(bytes);

            receive = receive.slice(length + 4);
        };

        function doSomething(bytes) {
            console.log('get data');
            console.log(bytes);
            return;

            bytes[0]++;
            bytes[1]=20;
            doSend(bytes);            

        }


        function doSend(bytes) {

            console.log('send data');
            console.log(bytes);

            var buffer = new ArrayBuffer(bytes.length + 4);
            var view = new DataView(buffer);           
            view.setInt32(0, bytes.length,true);
            for (var i = 0; i < bytes.length; i++) {
                view.setUint8(i + 4, bytes[i]);
            }
            webSocket.send(view);
        };


        //doSend([1, 2, 3, 4]);
        ///////////////



        

        //发送事件
        function WebSocketSendMsg() {

            doSend([91, 92, 93, 94]);

            ////获取text中的值
            //var text = document.getElementById("Text1").value;
            ////发送到服务器
            //webSocket.send(text);
        };
    </script>
</head>
<body >
    <div class="div1">
      
        <input type="text" id="Text1" />
        <input type="button" onclick="WebSocketSendMsg()" value="发送数据" />
    </div>
</body>
</html>